<!DOCTYPE html>
<html>
    <head>
        <link rel="manifest" href="/manifest.json">
        <script>
            window.addEventListener('load', function() {
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.register("/serviceWorker.js");
                }
            });
        </script>
    </head>
    <body>
        <h1>TheHome</h1>
        <div id="for_lit"></div>
        <div id="weather_ph"></div>
        <button id="authorize_button" style="display: none;">Authorize</button>
        <button id="signout_button" style="display: none;">Sign Out</button>
        <div id="inbox1">N_inbox_placeholder</div>
        <div id="cal_ph">Calendar placeholder</div>
        
    
        <script type="module">
            import {html, render} from 'https://unpkg.com/lit-html?module';
            const date_gene = date => html`
                <section id="clock">
                    <h2>${date.toLocaleString()}</h2>
                </section>
            `;
            const rendering = () => render(date_gene(new Date()), document.body.querySelector("#for_lit"));
            rendering();
            window.setInterval(rendering, 1*1000);
        </script>
    
        <script type="text/javascript">
            // Configs
            var CLIENT_ID = '830847602052-os8qbsv2iot82jeq8tliiorl1iocp7et.apps.googleusercontent.com';
            var API_KEY = 'AIzaSyABSPbwZGzgGnWt-xQAmHkkZsViaz91yt8';
            var DISCOVERY_DOCS = [
                "https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest",
                "https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest",
            ];
            var SCOPES = 'https://www.googleapis.com/auth/gmail.readonly https://www.googleapis.com/auth/calendar.readonly';
    
            var authorizeButton = document.getElementById('authorize_button');
            var signoutButton = document.getElementById('signout_button');
    
            async function handleClientLoad() {
            // Load client library, OAuth2 library
            await new Promise((resolve, reject)=>gapi.load('client:auth2', resolve));
    
            // Initialzie client library
            await gapi.client.init({
                apiKey: API_KEY,
                clientId: CLIENT_ID,
                discoveryDocs: DISCOVERY_DOCS,
                scope: SCOPES
            }).catch(err => {
                console.log(JSON.stringify(err, null, 2));
                throw "login error";
            });
            
            // Attach event handler for sign-in state changes.
            gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);
    
            // Attach listener for sign-in/out button
            updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
            authorizeButton.onclick = (event) => gapi.auth2.getAuthInstance().signIn();
            signoutButton.onclick   = (event) => gapi.auth2.getAuthInstance().signOut();
            }
    
            async function updateSigninStatus(isSignedIn) {
            authorizeButton.style.display = isSignedIn ? 'none' :'block';
            signoutButton.style.display   = isSignedIn ? 'block':'none';
            }
        </script>    

        <script async defer src="https://apis.google.com/js/api.js"
            onload="this.onload=function(){};handleClientLoad()"
            onreadystatechange="if (this.readyState === 'complete') this.onload()">
        </script>
        
        <script type="module">
            import {html, render} from 'https://unpkg.com/lit-html?module';
    
            // gapi should be initiated.
            async function count_inbox_mail(gapi_top) {
            const res = await gapi_top.client.gmail.users.messages.list({
                "userId": "me",
                "labelIds": ["INBOX", "CATEGORY_PERSONAL"],
                "maxResults": 500
            });
            console.log(res.result);
            return res.result.messages ? res.result.messages.length : res.result.resultSizeEstimate;
            }
    
            const update_N_inbox = async () => {
            // Get inbox mail number from Gmail server.
            const isSignedIn = gapi.auth2.getAuthInstance().isSignedIn.get();
            const N_inbox = isSignedIn ? await count_inbox_mail(gapi) : "Please Sign-in Google";
            render(html`
                <section>
                    <img src="New_Logo_Gmail.svg" />
                    <h3>inbox: ${N_inbox}</h3>
                </section>`
                ,document.body.querySelector("#inbox1"));
            }
    
            // Update with interval
            window.setTimeout(update_N_inbox, 10*1000);
            window.setInterval(update_N_inbox, 1*60*1000);
        </script>

        <script type="module">
            import {html, render} from 'https://unpkg.com/lit-html?module';

            async function testx(){
                const pos = await new Promise((resolve, reject) => navigator.geolocation.getCurrentPosition(resolve, reject));
                const lat = pos.coords.latitude;
                const lon = pos.coords.longitude;
                const appid = "6e6644f5775bc9020264ffb06173ba01";

                // current weather
                const res = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&units=metric&lang=ja&appid=${appid}`);
                const res_json = await res.json();
                const weather = res_json.weather[0].description;
                const weather_icon_url = `http://openweathermap.org/img/w/${res_json.weather[0].icon}.png`;
                const temp_C = res_json.main.temp;
                console.log(res_json);

                // weather forecast
                // const res = await fetch(`https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&units=metric&lang=ja&appid=${appid}`);

                render(html`
                <section id="weather">
                    <img src=${weather_icon_url} />
                    <h3>weather: ${weather}, ${temp_C}â„ƒ</h3>
                </section>`
                ,document.body.querySelector("#weather_ph"));
            }
            testx();
        </script>
        <script type="module">
            import {html, render} from 'https://unpkg.com/lit-html?module';

            async function listUpcomingEvents() {
                const response = await gapi.client.calendar.events.list({
                'calendarId': 'primary',
                'timeMin': (new Date()).toISOString(),
                'showDeleted': false,
                'singleEvents': true,
                'maxResults': 10,
                'orderBy': 'startTime'
                });
                const events = response.result.items;
                const x_hour = 2;
                const latestxh = events.filter(evt => (new Date(evt.start.dateTime) - new Date()) < x_hour*60*60*1000);
                const filtered_evts = latestxh.map(evt => evt.summary);
                const latest_evts = filtered_evts.length ? filtered_evts : ["No event"];
                console.log(latest_evts);
                console.log(`length: ${latest_evts.length}`);
                // const when = event.start.dateTime ? event.start.dateTime:event.start.date;
                render(html`
                    <section id="calender">
                        <ul>
                            ${latest_evts.map(evt => html`<li>${evt}</li>`)}
                        </ul>
                    </section>`
                    ,document.body.querySelector("#cal_ph")
                );                
            }
            window.setTimeout(listUpcomingEvents, 10000);
            window.setInterval(listUpcomingEvents, 3*60*1000);
        </script>
    </body>
</html>